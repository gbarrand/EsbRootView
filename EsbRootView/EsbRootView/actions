// Copyright (C) 2010, Guy Barrand. All rights reserved.
// See the file EsbRootView.license for terms.

#ifndef EsbRootView_EsbRootView_actions
#define EsbRootView_EsbRootView_actions

#include "event_timer"
#include "read_event"

#include "vis_plots"

#include <exlib/rroot/opener>

namespace EsbRootView {

inline inlib::sg::return_action action_start_events(inlib::sg::gui_viewer& a_gv,inlib::sg::entries& a_widget) {
  inlib::sg::view_evd* _evd = inlib::sg::cast_view_evd(a_gv);
  if(!_evd) {a_gv.insh().warn("EsbRootView::action_start_events","bad evd cast.");return inlib::sg::return_to_render;}
  dac* _dac = cast_dac(a_gv);
  if(!_dac) {a_gv.insh().warn("EsbRootView::action_start_events","bad dac cast.");return inlib::sg::return_to_render;}

  unsigned int start_event;
  INLIB_GUI_VIEWER_GET_WIDGET_UINT(action_start_event,0,start_event)
  unsigned int wanted_nevent;
  INLIB_GUI_VIEWER_GET_WIDGET_UINT(action_start_event,1,wanted_nevent)
  bool bof;
  INLIB_GUI_VIEWER_GET_WIDGET_BOOL(action_start_event,2,bof)

  INLIB_GUI_VIEWER_GET_WIDGET_UINT(action_start_event,3,_evd->next_event_sleep())

  inlib::uint64 number = _dac->number_of_events();
  if(!number) {
    a_gv.insh().warn("EsbRootView::action_start_event","no event in file.");
    return inlib::sg::return_to_render;     
  }

  if(!wanted_nevent) {
    a_gv.insh().warn("EsbRootView::action_start_event","nothing to do.");
    return inlib::sg::return_to_render;     
  }

  _evd->event_index() = start_event;

  a_gv.stop_event_anim();

  event_timer* timer = new event_timer(a_gv,number,wanted_nevent,bof,_evd->next_event_sleep());

  a_gv.set_event_anim(timer);

  a_gv.hide_main_menu();
  return inlib::sg::return_to_render;
}

inline inlib::sg::return_action action_menu_vis_events(inlib::sg::gui_viewer& a_gv) {
  inlib::sg::view_evd* _evd = inlib::sg::cast_view_evd(a_gv);
  if(!_evd) return inlib::sg::return_none;

  inlib::sg::entries* entries = new inlib::sg::entries(a_gv.ttf());
  a_gv.set_style(*entries);

  entries->add_uint("start at",_evd->event_index());
  entries->add_uint("num events",100);
  entries->add_bool("eof->bof",false);
  entries->add_uint("next event sleep (msec)",_evd->next_event_sleep());

  inlib::sg::add_callback(a_gv,*entries,action_start_events);

  a_gv.push_list(entries);
  return inlib::sg::return_to_render;
}

inline inlib::sg::return_action action_start_insh_anim(inlib::sg::gui_viewer& a_gv,inlib::sg::entries& a_widget) {
  inlib::sg::view_evd* _evd = inlib::sg::cast_view_evd(a_gv);
  if(!_evd) return inlib::sg::return_none;
  
  double time_min;
  INLIB_GUI_VIEWER_GET_WIDGET_DOUBLE(action_start_insh_anim,0,time_min)
  double time_max;
  INLIB_GUI_VIEWER_GET_WIDGET_DOUBLE(action_start_insh_anim,1,time_max)
  double delay;
  INLIB_GUI_VIEWER_GET_WIDGET_DOUBLE(action_start_insh_anim,2,delay)
  bool end_begin;
  INLIB_GUI_VIEWER_GET_WIDGET_BOOL(action_start_insh_anim,3,end_begin)
  bool show_console;
  INLIB_GUI_VIEWER_GET_WIDGET_BOOL(action_start_insh_anim,4,show_console)
  bool scene_clear_dynamic;
  INLIB_GUI_VIEWER_GET_WIDGET_BOOL(action_start_insh_anim,5,scene_clear_dynamic)
  bool set_v;
  INLIB_GUI_VIEWER_GET_WIDGET_BOOL(action_start_insh_anim,6,set_v)
  bool set_x;
  INLIB_GUI_VIEWER_GET_WIDGET_BOOL(action_start_insh_anim,7,set_x)
  
  //inlib::sg::style _style;
  //if(!a_gv.styles().res_sg_style<inlib::sg::style>("insh_anim",_style)) {}

  std::vector<std::string> lines;
  lines.push_back(". anim.insh");  //sourced so that set_v, set_x can apply.

  a_gv.insh().reset_to_stop();

  inlib::sg::insh_anim* _anim = new inlib::sg::insh_anim(inlib::atime::now(),a_gv.insh());
  _anim->time_min = time_min;
  _anim->time_max = time_max;
  _anim->delay = delay;
  _anim->end_begin = end_begin;
  _anim->show_console = show_console;
  _anim->set_v = set_v;
  _anim->set_x = set_x;
  _anim->script = lines;

  if(!_anim->is_valid()) {
    a_gv.insh().warn("EsbRootView::action_start_insh_anim","insh_anim not valid.");
    delete _anim;
    return inlib::sg::return_to_render;
  }

  if(scene_clear_dynamic) _evd->dynamic_sg().clear();

  _evd->dynamic_sg().add(_anim);

  a_gv.enable_anim();

  a_gv.hide_main_menu();
  return inlib::sg::return_to_render;
}

inline inlib::sg::return_action action_menu_insh_anim(inlib::sg::gui_viewer& a_gv) {
  inlib::sg::view_evd* _evd = inlib::sg::cast_view_evd(a_gv);
  if(!_evd) return inlib::sg::return_none;
  dac* _dac = cast_dac(a_gv);
  if(!_dac) return inlib::sg::return_none;

  inlib::sg::entries* entries = new inlib::sg::entries(a_gv.ttf());
  a_gv.set_style(*entries);

  entries->add_double("event time min (nsec)",_dac->event().time_min());
  entries->add_double("event time max (nsec)",_dac->event().time_max());
  entries->add_double("sys delay (sec)",10);
  entries->add_bool("end->begin",false);
  entries->add_bool("show_console",true);
  entries->add_bool("scene clear dynamic",true);
  entries->add_bool("set -v",false);
  entries->add_bool("set -x",false);

  inlib::sg::add_callback(a_gv,*entries,action_start_insh_anim);

  a_gv.push_list(entries);
  return inlib::sg::return_to_render;
}

///////////////////////////////////////////////////////////////
/// neard/fard : //////////////////////////////////////////////
///////////////////////////////////////////////////////////////
/*
inline inlib::sg::return_action action_setup_neard(inlib::sg::gui_viewer& a_gv) {

 {std::string from = a_gv.res_dir()+inlib::sep()+"neard_startup.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"startup.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

 {std::string from = a_gv.res_dir()+inlib::sep()+"neard_event.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"event.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

  a_gv.show_console("res_dir/neard_[startup,event].insh copied to doc_dir/[startup,event].insh");

  return inlib::sg::return_to_render;
}

inline inlib::sg::return_action action_setup_fard(inlib::sg::gui_viewer& a_gv) {

 {std::string from = a_gv.res_dir()+inlib::sep()+"fard_startup.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"startup.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

 {std::string from = a_gv.res_dir()+inlib::sep()+"fard_event.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"event.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

  a_gv.show_console("res_dir/fard_[startup,event].insh copied to doc_dir/[startup,event].insh");

  return inlib::sg::return_to_render;
}

inline inlib::sg::return_action action_setup_fgd(inlib::sg::gui_viewer& a_gv) {

 {std::string from = a_gv.res_dir()+inlib::sep()+"fgd_startup.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"startup.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

 {std::string from = a_gv.res_dir()+inlib::sep()+"fgd_event.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"event.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

  a_gv.show_console("res_dir/fgd_[startup,event].insh copied to doc_dir/[startup,event].insh");

  return inlib::sg::return_to_render;
}

inline inlib::sg::return_action action_setup_fgd_hit(inlib::sg::gui_viewer& a_gv) {

 {std::string from = a_gv.res_dir()+inlib::sep()+"fgd_hit_startup.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"startup.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

 {std::string from = a_gv.res_dir()+inlib::sep()+"fgd_hit_event.insh";
  std::string to = a_gv.doc_dir()+inlib::sep()+"event.insh";
  if(!inlib::file::copy_bytes(from,to)) {
    a_gv.insh().warn("can't copy "+inlib::sout(from)+" to "+inlib::sout(to));
    return inlib::sg::return_to_render;
  }}

  a_gv.show_console("res_dir/fgd_hit_[startup,event].insh copied to doc_dir/[startup,event].insh");

  return inlib::sg::return_to_render;
}
*/

inline inlib::sg::return_action action_menu_setups(inlib::sg::gui_viewer& a_gv) {
  inlib::sg::list* list = new inlib::sg::list(a_gv.ttf());
  a_gv.set_style(*list);

 {std::string script = "\
res_dir=`app_dir -res`\n\
doc_dir=`app_dir -doc`\n\
sep=`sys_file_sep`  # it handles UNIX and Windows/DOS cases.\n\
mkdir -p ${doc_dir}\n\
cp ${res_dir}${sep}neard_startup.insh ${doc_dir}${sep}startup.insh\n\
cp ${res_dir}${sep}neard_event.insh   ${doc_dir}${sep}event.insh\n\
cp ${res_dir}${sep}neard_anim.insh    ${doc_dir}${sep}anim.insh\n\
. ${doc_dir}${sep}startup.insh\n\
#show_console res_dir/neard_[startup,event].insh copied to doc_dir/[startup,event].insh\n\
";
  inlib::sg::add_white_item_insh(a_gv,*list,"neard",script);}
  
 {std::string script = "\
res_dir=`app_dir -res`\n\
doc_dir=`app_dir -doc`\n\
sep=`sys_file_sep`  # it handles UNIX and Windows/DOS cases.\n\
mkdir -p ${doc_dir}\n\
cp ${res_dir}${sep}fard_startup.insh ${doc_dir}${sep}startup.insh\n\
cp ${res_dir}${sep}fard_event.insh   ${doc_dir}${sep}event.insh\n\
cp ${res_dir}${sep}fard_anim.insh    ${doc_dir}${sep}anim.insh\n\
. ${doc_dir}${sep}startup.insh\n\
#show_console res_dir/fard_[startup,event].insh copied to doc_dir/[startup,event].insh\n\
";
  inlib::sg::add_white_item_insh(a_gv,*list,"fard",script);}
  
 {std::string script = "\
res_dir=`app_dir -res`\n\
doc_dir=`app_dir -doc`\n\
sep=`sys_file_sep`  # it handles UNIX and Windows/DOS cases.\n\
mkdir -p ${doc_dir}\n\
cp ${res_dir}${sep}fgd_startup.insh ${doc_dir}${sep}startup.insh\n\
cp ${res_dir}${sep}fgd_event.insh   ${doc_dir}${sep}event.insh\n\
cp ${res_dir}${sep}fgd_anim.insh    ${doc_dir}${sep}anim.insh\n\
. ${doc_dir}${sep}startup.insh\n\
#show_console res_dir/fgd_[startup,event].insh copied to doc_dir/[startup,event].insh\n\
";
  inlib::sg::add_white_item_insh(a_gv,*list,"fgd",script);}
  
 {std::string script = "\
res_dir=`app_dir -res`\n\
doc_dir=`app_dir -doc`\n\
sep=`sys_file_sep`  # it handles UNIX and Windows/DOS cases.\n\
mkdir -p ${doc_dir}\n\
cp ${res_dir}${sep}fgd_hit_startup.insh ${doc_dir}${sep}startup.insh\n\
cp ${res_dir}${sep}fgd_hit_event.insh   ${doc_dir}${sep}event.insh\n\
cp ${res_dir}${sep}fgd_hit_anim.insh    ${doc_dir}${sep}anim.insh\n\
. ${doc_dir}${sep}startup.insh\n\
#show_console res_dir/fgd_hit_[startup,event].insh copied to doc_dir/[startup,event].insh\n\
";
  inlib::sg::add_white_item_insh(a_gv,*list,"fgd_hit",script);}

 {std::string script = "\
doc_dir=`app_dir -doc`\n\
sep=`sys_file_sep`  # it handles UNIX and Windows/DOS cases.\n\
rm ${doc_dir}${sep}startup.insh\n\
rm ${doc_dir}${sep}event.insh\n\
rm ${doc_dir}${sep}anim.insh\n\
";
  inlib::sg::add_white_item_insh(a_gv,*list,"reset",script);}

  a_gv.push_list(list);
  return inlib::sg::return_to_render;
}

///////////////////////////////////////////////////////////////
/// neard/fard : //////////////////////////////////////////////
///////////////////////////////////////////////////////////////

inline inlib::sg::return_action action_menu_neard(inlib::sg::gui_viewer& a_gv) {
  inlib::sg::list* list = new inlib::sg::list(a_gv.ttf());
  a_gv.set_style(*list);

  inlib::sg::add_white_item_insh(a_gv,*list,"geometry"  ,"neard_vis_geometry\ngui_hide_main_menu");
  inlib::sg::add_white_item_insh(a_gv,*list,"set camera","neard_set_camera\ngui_hide_main_menu");
  inlib::sg::add_white_item_insh(a_gv,*list,"floor"     ,"neard_vis_floor\ngui_hide_main_menu");  
  inlib::sg::add_white_item_insh(a_gv,*list,"sarah"     ,"neard_vis_sarah\ngui_hide_main_menu");

  a_gv.push_list(list);
  return inlib::sg::return_to_render;
}

inline inlib::sg::return_action action_menu_fard(inlib::sg::gui_viewer& a_gv) {
  inlib::sg::list* list = new inlib::sg::list(a_gv.ttf());
  a_gv.set_style(*list);

  inlib::sg::add_white_item_insh(a_gv,*list,"geometry"  ,"fard_vis_geometry\ngui_hide_main_menu");
  inlib::sg::add_white_item_insh(a_gv,*list,"set camera","fard_set_camera\ngui_hide_main_menu");
  inlib::sg::add_white_item_insh(a_gv,*list,"floor"     ,"fard_vis_floor\ngui_hide_main_menu");  
  inlib::sg::add_white_item_insh(a_gv,*list,"sarah"     ,"fard_vis_sarah\ngui_hide_main_menu");

  a_gv.push_list(list);
  return inlib::sg::return_to_render;
}

///////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////

inline inlib::sg::return_action action_menu_vis_event_items(inlib::sg::gui_viewer& a_gv) {
  inlib::sg::list* list = new inlib::sg::list(a_gv.ttf());
  a_gv.set_style(*list);

  /////////////////////////////////////////////////////////////////////////
  /////////////////////////////////////////////////////////////////////////
  /////////////////////////////////////////////////////////////////////////
  inlib::sg::add_white_item_insh(a_gv,*list,"vis MCTracks"          ,"event_vis MCTrack\ngui_hide_main_menu");
  inlib::sg::add_white_item_insh(a_gv,*list,"vis WCDetectorPoints"  ,"event_vis WCDetectorPoint\ngui_hide_main_menu");
  inlib::sg::add_white_item_insh(a_gv,*list,"vis FgdDetectorPoints" ,"event_vis FgdDetectorPoint\ngui_hide_main_menu");
  inlib::sg::add_white_item_insh(a_gv,*list,"vis FgdHits"           ,"event_vis FgdHit\ngui_hide_main_menu");
  
  /////////////////////////////////////////////////////////////////////////
  /////////////////////////////////////////////////////////////////////////
  /////////////////////////////////////////////////////////////////////////
  a_gv.push_list(list);
  return inlib::sg::return_to_render;
}

///////////////////////////////////////////////////////////////
/// plotting : ////////////////////////////////////////////////
///////////////////////////////////////////////////////////////

#define ACTION_PLOT_DATA(a__action,a__data,a__evaluator,a__cut,a__variable) \
inline inlib::sg::return_action a__action##_##a__data##_2(inlib::sg::gui_viewer& a_gv,inlib::sg::entries& a_widget) {\
  const std::string& scut = a_widget.values[0];\
  const std::string& svar = a_widget.values[1];\
  std::vector<std::string> lines;\
  std::string sargs;\
  if(scut.size()) sargs += " -cut="+scut;\
  if(svar.size()) sargs += " -filling="+svar;\
  lines.push_back("event_plot "+std::string(#a__data)+" "+sargs);\
  lines.push_back("gui_hide_main_menu");\
  a_gv.insh().exec_lines_reset_to_stop(lines);\
  return inlib::sg::return_to_render;\
}\
inline inlib::sg::return_action a__action##_##a__data##_1(inlib::sg::gui_viewer& a_gv) {\
  inlib::sg::entries* entries = new inlib::sg::entries(a_gv.ttf());\
  a_gv.set_style(*entries);\
  entries->add_string("cut",#a__cut);\
 {dac* _dac = cast_dac(a_gv);\
  if(_dac) {\
    Esb##a__evaluator##_evaluator _eval(a_gv.out(),"",_dac->event());\
    std::vector<std::string> names;\
    _eval.get_names(names);\
    entries->add_opts("filling",#a__variable,names);\
  }}\
  inlib::sg::add_callback(a_gv,*entries,a__action##_##a__data##_2);\
  a_gv.push_list(entries);\
  return inlib::sg::return_to_render;\
}

ACTION_PLOT_DATA(action_plot,MCTrack,MCTrack,pdg==50000050,p)
ACTION_PLOT_DATA(action_plot,WCDetectorPoint,DetectorPoint,pdg==50000050,p)
ACTION_PLOT_DATA(action_plot,FgdDetectorPoint,DetectorPoint,,p)
ACTION_PLOT_DATA(action_plot,FgdHit,FgdHit,,photoE)

inline inlib::sg::return_action action_menu_plot_items(inlib::sg::gui_viewer& a_gv) {
  inlib::sg::list* list = new inlib::sg::list(a_gv.ttf());
  a_gv.set_style(*list);

  inlib::sg::add_white_item_insh(a_gv,*list,"plots full window","plots_full_window\ngui_hide_main_menu");

  inlib::sg::add_white_item(a_gv,*list,"plot MCTracks ?",action_plot_MCTrack_1);
  inlib::sg::add_white_item(a_gv,*list,"plot WCDetectorPoints ?",action_plot_WCDetectorPoint_1);

//inlib::sg::add_white_item_insh(a_gv,*list,"plot WCDetectorPoints points neard","WCDetectorPoint_plot -modeling=neard\ngui_hide_main_menu");
//inlib::sg::add_white_item_insh(a_gv,*list,"plot WCDetectorPoints points fard","WCDetectorPoint_plot -modeling=fard\ngui_hide_main_menu");

  inlib::sg::add_white_item(a_gv,*list,"plot FgdDetectorPoints ?",action_plot_FgdDetectorPoint_1);
  inlib::sg::add_white_item(a_gv,*list,"plot FgdHits ?",action_plot_FgdHit_1);

  inlib::sg::add_image_item(a_gv,*list,"plots","set_current_region.jpg",inlib::sg::action_menu_plots_layout);
  
  a_gv.push_list(list);
  return inlib::sg::return_to_render;
}

#undef ACTION_PLOT_DATA

}

#endif
